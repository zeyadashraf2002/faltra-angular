<!-- ๐ companies.component.html - WITH CASH SUBSCRIPTION MODAL -->
<div class="dashboard-container" dir="rtl">
  
  <!-- Top Navigation Bar -->
  <nav class="dashboard-nav">
    <div class="nav-content">
      <div class="nav-brand">
        <img src="assets/logo.png" alt="ููุชุฑู" class="nav-logo-img">
        <div>
          <h5>ููุชุฑู</h5>
          <small>ุฅุฏุงุฑุฉ ุงูุดุฑูุงุช</small>
        </div>
      </div>
      
      <div class="nav-user">
        <!-- โจ NEW: Stats Dashboard Button (Developer Only) -->
        @if (authService.currentUser?.role === 'developer') {
          <button class="btn-stats" (click)="goToStats()">
            <i class="bi bi-graph-up-arrow"></i>
            <span>ุฅุญุตุงุฆูุงุช ุงูุงุดุชุฑุงูุงุช</span>
          </button>
        }
        
        <div class="user-info">
          <strong>{{ authService.currentUser?.fullName }}</strong>
          <span class="user-role">
            {{ authService.currentUser?.role === 'developer' ? 'ูุทูุฑ' : 'ูุฏูุฑ' }}
          </span>
        </div>
        <button class="btn-logout" (click)="logout()">
          <i class="bi bi-box-arrow-left"></i>
          ุฎุฑูุฌ
        </button>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="dashboard-main">
    <div class="container-fluid">
      
      <!-- Page Header -->
      <div class="page-header">
        <div>
          <h1>ุฅุฏุงุฑุฉ ุงูุดุฑูุงุช</h1>
          <p>ุนุฑุถ ููุชุงุจุนุฉ ุจูุงูุงุช ุงูุดุฑูุงุช ูุงูุงุดุชุฑุงูุงุช</p>
        </div>
        <div class="stats-badge">
          <i class="bi bi-buildings"></i>
          <span>{{ filteredCompanies.length }} ุดุฑูุฉ</span>
        </div>
      </div>

      <!-- Search & Filter Toolbar -->
      <div class="toolbar">
        <div class="search-box">
          <i class="bi bi-search"></i>
          <input 
            type="text" 
            placeholder="ุงุจุญุซ ุนู ุดุฑูุฉ..."
            [(ngModel)]="searchQuery"
            (input)="onSearchChange()">
        </div>

        <div class="filter-buttons">
          <button 
            class="filter-btn"
            [class.active]="subscriptionFilter === 'all'"
            (click)="setSubscriptionFilter('all')">
            <i class="bi bi-list-ul"></i>
            <span>ุงููู</span>
          </button>
          <button 
            class="filter-btn filter-active"
            [class.active]="subscriptionFilter === 'active'"
            (click)="setSubscriptionFilter('active')">
            <i class="bi bi-check-circle"></i>
            <span>ุณุงุฑู</span>
          </button>
          <button 
            class="filter-btn filter-expired"
            [class.active]="subscriptionFilter === 'expired'"
            (click)="setSubscriptionFilter('expired')">
            <i class="bi bi-x-circle"></i>
            <span>ููุชูู</span>
          </button>
        </div>
      </div>

      <!-- Loading State -->
      @if (isLoading) {
        <div class="loading-state">
          <div class="spinner"></div>
          <p>ุฌุงุฑู ุชุญููู ุงูุดุฑูุงุช...</p>
        </div>
      }

      <!-- Empty State -->
      @if (!isLoading && filteredCompanies.length === 0) {
        <div class="empty-state">
          <i class="bi bi-inbox"></i>
          <h3>ูุง ุชูุฌุฏ ุดุฑูุงุช</h3>
          <p>ูู ูุชู ุงูุนุซูุฑ ุนูู ุฃู ุดุฑูุงุช ูุทุงุจูุฉ</p>
        </div>
      }

      <!-- Companies Grid -->
      @if (!isLoading && filteredCompanies.length > 0) {
        <div class="companies-grid">
          @for (company of paginatedCompanies; track company.id) {
            <div class="company-card">
              
              <!-- Card Header -->
              <div class="card-header">
                <div class="company-identity">
                  @if (company.logo) {
                    <img [src]="company.logo" [alt]="company.name" class="company-logo">
                  } @else {
                    <div class="company-logo-placeholder">
                      <i class="bi bi-building"></i>
                    </div>
                  }
                  <div>
                    <h3>{{ company.name }}</h3>
                    <span class="company-id">#{{ company.id }}</span>
                  </div>
                </div>
                
                <div class="status-badge"
                     [class.active]="!isExpired(company.subscriptionExpiryDate)"
                     [class.expired]="isExpired(company.subscriptionExpiryDate)">
                  {{ isExpired(company.subscriptionExpiryDate) ? 'ููุชูู' : 'ุณุงุฑู' }}
                </div>
              </div>

              <!-- Card Body -->
              <div class="card-body">
                <div class="info-grid">
                  
                  <div class="info-row">
                    <i class="bi bi-geo-alt"></i>
                    <div>
                      <label>ุงูุนููุงู</label>
                      <span>{{ company.address || 'ุบูุฑ ูุญุฏุฏ' }}</span>
                    </div>
                  </div>

                  <div class="info-row">
                    <i class="bi bi-envelope"></i>
                    <div>
                      <label>ุงูุจุฑูุฏ</label>
                      <span>{{ company.email || 'ุบูุฑ ูุญุฏุฏ' }}</span>
                    </div>
                  </div>

                  <div class="info-row">
                    <i class="bi bi-telephone"></i>
                    <div>
                      <label>ุงููุงุชู</label>
                      <span>{{ company.phone || 'ุบูุฑ ูุญุฏุฏ' }}</span>
                    </div>
                  </div>

                  <div class="info-row">
                    <i class="bi bi-calendar-check"></i>
                    <div>
                      <label>ุชุงุฑูุฎ ุงูุฅูุดุงุก</label>
                      <span>{{ company.createdAt | date: 'dd/MM/yyyy' }}</span>
                    </div>
                  </div>

                  <div class="info-row highlight expiry-row">
                    <i class="bi bi-calendar-x" 
                       [class.text-danger]="isExpired(company.subscriptionExpiryDate)"
                       [class.text-success]="!isExpired(company.subscriptionExpiryDate)">
                    </i>
                    <div class="expiry-content">
                      <div>
                        <label>ุงูุชูุงุก ุงูุงุดุชุฑุงู</label>
                        <span [class.text-danger]="isExpired(company.subscriptionExpiryDate)"
                              [class.text-success]="!isExpired(company.subscriptionExpiryDate)">
                          {{ company.subscriptionExpiryDate | date: 'dd/MM/yyyy' }}
                        </span>
                      </div>
                    </div>
                  </div>

                </div>
              </div>

              <!-- Card Footer -->
              <div class="card-footer">
                <button 
                  class="btn-details" 
                  (click)="viewCompanyDetails(company.id)"
                  title="ุนุฑุถ ุงูุชูุงุตูู ุงููุงููุฉ">
                  <i class="bi bi-file-text"></i>
                  <span>ุนุฑุถ ุชูุงุตูู ุงูุงุดุชุฑุงู ูุงูููุงุชูุฑ</span>
                  <i class="bi bi-arrow-left"></i>
                </button>
                
                <!-- โจ NEW: Add Cash Subscription Button (Developer Only) -->
                @if (authService.currentUser?.role === 'developer') {
                  <button 
                    class="btn-add-subscription" 
                    (click)="openAddSubscriptionModal(company)"
                    title="ุฅุถุงูุฉ ุงุดุชุฑุงู ูุงุด">
                    <i class="bi bi-cash-coin"></i>
                    <span>ุฅุถุงูุฉ ุงุดุชุฑุงู ูุงุด</span>
                  </button>
                }
              </div>

            </div>
          }
        </div>
      }

      <!-- Pagination -->
      @if (totalPages > 1) {
        <nav class="pagination-nav">
          <button 
            class="btn-page"
            [disabled]="currentPage === 1"
            (click)="goToPage(currentPage - 1)">
            <i class="bi bi-chevron-right"></i>
            ุงูุณุงุจู
          </button>
          
          <div class="page-numbers">
            @for (page of pages; track page) {
              <button 
                class="btn-page-number"
                [class.active]="page === currentPage"
                (click)="goToPage(page)">
                {{ page }}
              </button>
            }
          </div>
          
          <button 
            class="btn-page"
            [disabled]="currentPage === totalPages"
            (click)="goToPage(currentPage + 1)">
            ุงูุชุงูู
            <i class="bi bi-chevron-left"></i>
          </button>
        </nav>
      }

    </div>
  </div>
</div>

<!-- ========================================== -->
<!-- ๐ CASH SUBSCRIPTION MODAL -->
<!-- ========================================== -->
@if (showAddSubscriptionModal) {
  <div class="modal-overlay" (click)="closeAddSubscriptionModal()">
    <div class="modal-dialog" (click)="$event.stopPropagation()">
      
      <!-- Modal Header -->
      <div class="modal-header">
        <h3>
          <i class="bi bi-cash-coin"></i>
          ุฅุถุงูุฉ ุงุดุชุฑุงู ูุงุด
        </h3>
        <button class="btn-close" (click)="closeAddSubscriptionModal()">
          <i class="bi bi-x"></i>
        </button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body">
        
        <!-- Company Info -->
        @if (selectedCompany) {
          <div class="company-name">
            <i class="bi bi-building"></i>
            <span>{{ selectedCompany.name }}</span>
          </div>
        }

        <!-- Plan Selection -->
        <div class="form-group">
          <label for="planId" class="form-label">
            <i class="bi bi-award"></i>
            ุงุฎุชุฑ ุงูุจุงูุฉ
          </label>
          <select
            id="planId"
            class="form-control"
            [(ngModel)]="cashSubscriptionForm.planId"
            [disabled]="isSubmittingCash || isLoadingPlans"
            required>
            <option [value]="null" disabled selected>ุงุฎุชุฑ ุจุงูุฉ...</option>
            @for (plan of availablePlans; track plan.id) {
              <option [value]="plan.id">
                {{ plan.nameAr }} - {{ plan.price }} ุฌููู ({{ plan.durationDays }} ููู)
              </option>
            }
          </select>
        </div>

        <!-- Notes (Optional) -->
        <div class="form-group">
          <label for="notes" class="form-label">
            <i class="bi bi-chat-text"></i>
            ููุงุญุธุงุช (ุงุฎุชูุงุฑู)
          </label>
          <textarea
            id="notes"
            class="form-control"
            [(ngModel)]="cashSubscriptionForm.notes"
            [disabled]="isSubmittingCash"
            rows="3"
            placeholder="ุฃู ููุงุญุธุงุช ุฅุถุงููุฉ..."></textarea>
        </div>

        <div class="form-hint">
          <i class="bi bi-info-circle"></i>
          <span>ุณูุชู ุฅุถุงูุฉ ุงูุงุดุชุฑุงู ููุฑุงู ุจุฏูู ุฏูุน ุฅููุชุฑููู</span>
        </div>

      </div>

      <!-- Modal Footer -->
      <div class="modal-footer">
        <button 
          class="btn-secondary" 
          (click)="closeAddSubscriptionModal()"
          [disabled]="isSubmittingCash">
          <i class="bi bi-x-circle"></i>
          ุฅูุบุงุก
        </button>
        <button 
          class="btn-primary" 
          (click)="submitCashSubscription()"
          [disabled]="!cashSubscriptionForm.planId || isSubmittingCash">
          @if (!isSubmittingCash) {
            <span>
              <i class="bi bi-check-circle"></i>
              ุฅุถุงูุฉ ุงูุงุดุชุฑุงู
            </span>
          }
          @if (isSubmittingCash) {
            <span class="loading-state">
              <span class="spinner-sm"></span>
              ุฌุงุฑู ุงูุฅุถุงูุฉ...
            </span>
          }
        </button>
      </div>

    </div>
  </div>
}