<!-- ๐ subscription-dashboard.component.html - FINAL CLEAN VERSION -->
<div class="dashboard-container" dir="rtl">
  
  <nav class="dashboard-nav">
    <div class="nav-content">
      <div class="nav-brand">
        <img src="assets/logo.png" alt="ููุชุฑู" class="nav-logo-img">
        <div>
          <h5>ููุชุฑู</h5>
          <small>ุฅุญุตุงุฆูุงุช ุงูุงุดุชุฑุงูุงุช</small>
        </div>
      </div>
      <div class="nav-actions">
        <button class="btn-companies" (click)="goToCompanies()">
          <i class="bi bi-buildings"></i> <span>ุงูุดุฑูุงุช</span>
        </button>
        <button class="btn-logout" (click)="logout()">
          <i class="bi bi-box-arrow-left"></i> <span>ุฎุฑูุฌ</span>
        </button>
      </div>
    </div>
  </nav>

  <div class="dashboard-main">
    <div class="container-fluid">
      
      <div class="page-header">
        <h1>ุฅุญุตุงุฆูุงุช ุงูุงุดุชุฑุงูุงุช</h1>
        <p>ูุธุฑุฉ ุดุงููุฉ ุนูู ุฏุฎู ุงูุงุดุชุฑุงูุงุช ูุงูุดุฑูุงุช ุงููุดุชุฑูุฉ</p>
      </div>

      <div class="filters-section">
        <div class="filter-group">
          <label><i class="bi bi-calendar-month"></i> ุงูุดูุฑ</label>
          <select [(ngModel)]="selectedMonth" (change)="onMonthChange()" class="form-select">
            <option [value]="1">ููุงูุฑ</option><option [value]="2">ูุจุฑุงูุฑ</option><option [value]="3">ูุงุฑุณ</option>
            <option [value]="4">ุฃุจุฑูู</option><option [value]="5">ูุงูู</option><option [value]="6">ููููู</option>
            <option [value]="7">ููููู</option><option [value]="8">ุฃุบุณุทุณ</option><option [value]="9">ุณุจุชูุจุฑ</option>
            <option [value]="10">ุฃูุชูุจุฑ</option><option [value]="11">ููููุจุฑ</option><option [value]="12">ุฏูุณูุจุฑ</option>
          </select>
        </div>
        <div class="filter-group">
          <label><i class="bi bi-calendar"></i> ุงูุณูุฉ</label>
          <select [(ngModel)]="selectedYear" (change)="onYearChange()" class="form-select">
            @for (year of availableYears; track year) {
              <option [value]="year">{{ year }}</option>
            }
          </select>
        </div>
      </div>

      @if (isLoading) {
        <div class="loading-state">
          <div class="spinner"></div>
          <p>ุฌุงุฑู ุชุญููู ุงูุฅุญุตุงุฆูุงุช...</p>
        </div>
      }

      @if (!isLoading && stats) {
        <!-- Stats Cards -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon revenue"><i class="bi bi-cash-stack"></i></div>
            <div class="stat-content">
              <label>ุฏุฎู {{ stats.period.monthName }}</label>
              <h2>{{ formatCurrency(stats.monthly.revenue) }}</h2>
              <span class="stat-meta">{{ stats.monthly.invoicesCount }} ูุงุชูุฑุฉ</span>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon yearly"><i class="bi bi-graph-up-arrow"></i></div>
            <div class="stat-content">
              <label>ุฏุฎู ุงูุณูุฉ {{ stats.period.year }}</label>
              <h2>{{ formatCurrency(stats.yearly.revenue) }}</h2>
              <span class="stat-meta">{{ stats.yearly.invoicesCount }} ูุงุชูุฑุฉ</span>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon active"><i class="bi bi-check-circle"></i></div>
            <div class="stat-content">
              <label>ุงุดุชุฑุงูุงุช ูุดุทุฉ</label>
              <h2>{{ stats.subscriptions.active }}</h2>
              <span class="stat-meta">ุดุฑูุฉ ูุดุชุฑูุฉ (ูุฏููุนุฉ)</span>
            </div>
          </div>

         <div class="stat-card">
            <div class="stat-icon trial"><i class="bi bi-gift"></i></div>
            <div class="stat-content">
              <label>ุดุฑูุงุช ุชุฌุฑูุจูุฉ</label>
              <h2>{{ stats.subscriptions.trial }}</h2>
              <span class="stat-meta">ุชุญุช ุงูุชุฌุฑุจุฉ ุญุงูููุง</span>
            </div>
          </div>
        </div>

        <!-- 1. ุงุดุชุฑุงูุงุช ุชูุชูู ุฎูุงู 7 ุฃูุงู (ูุฏููุนุฉ + ุชุฌุฑูุจูุฉ) -->
        @if (stats.expiringSoon && stats.expiringSoon.length > 0) {
          <div class="collapsible-section">
            <div class="section-header" (click)="toggleExpiring()">
              <div class="header-left">
                <h3><i class="bi bi-exclamation-triangle-fill"></i> ุชูุชูู ุฎูุงู 7 ุฃูุงู</h3>
                <span class="count-badge badge-danger">{{ stats.expiringSoon.length }}</span>
              </div>
              <i class="bi" [class.bi-chevron-up]="isExpiringOpen" [class.bi-chevron-down]="!isExpiringOpen"></i>
            </div>

            @if (isExpiringOpen) {
              <div class="section-content">
                <div class="table-wrapper">
                  <table class="data-table">
                    <thead>
                      <tr>
                        <th>#</th>
                        <th>ุงูุดุฑูุฉ</th>
                        <th>ุงูุจุงูุฉ</th>
                        <th>ุงููุจูุบ</th>
                        <th>ุชุงุฑูุฎ ุงูุงูุชูุงุก</th>
                        <th>ุงูุฃูุงู ุงููุชุจููุฉ</th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (sub of stats.expiringSoon; track sub.id) {
                        <tr>
                          <td>#{{ sub.id }}</td>
                          <td>
                            <div class="company-info">
                              <strong>{{ sub.company.name }}</strong>
                              <small>{{ sub.company.email }}</small>
                            </div>
                          </td>
                          <td>
                            <span class="badge" 
                                  [ngClass]="sub.plan.name === 'Trial' ? 'badge-warning' : 'badge-primary'">
                              {{ sub.plan.nameAr || (sub.plan.name === 'Trial' ? 'ุชุฌุฑุจุฉ ูุฌุงููุฉ' : sub.plan.nameAr) }}
                            </span>
                          </td>
                          <td class="amount">
                            {{ sub.plan.name === 'Trial' ? 'ูุฌุงูู' : formatCurrency(sub.plan.price) }}
                          </td>
                          <td class="date">{{ sub.endDate | date: 'dd/MM/yyyy' }}</td>
                          <td>
                            <span class="badge" [ngClass]="getDaysRemainingClass(sub.daysRemaining || 0)">
                              {{ sub.daysRemaining || 0 }} ููู
                            </span>
                          </td>
                        </tr>
                      }
                    </tbody>
                  </table>
                </div>
              </div>
            }
          </div>
        }

        <!-- 2. ุฃุญุฏุซ ุงูุงุดุชุฑุงูุงุช ุงููุดุทุฉ (ูุน ููุชุฑ ุชุฌุฑูุจู) -->
        <div class="collapsible-section">
          <div class="section-header" (click)="toggleActive()">
            <div class="header-left">
              <h3><i class="bi bi-check-circle-fill"></i> ุฃุญุฏุซ ุงูุงุดุชุฑุงูุงุช ุงููุดุทุฉ</h3>
              <span class="count-badge badge-success">{{ filteredRecentSubscriptions.length }}</span>
            </div>
            <i class="bi" [class.bi-chevron-up]="isActiveOpen" [class.bi-chevron-down]="!isActiveOpen"></i>
          </div>

          @if (isActiveOpen) {
            <div class="section-content">
              <div class="filter-row">
                <label>ููุชุฑุฉ ุญุณุจ ุงูุจุงูุฉ:</label>
                <select [(ngModel)]="selectedPlanFilter" class="form-select">
                  <option value="all">ุฌููุน ุงูุจุงูุงุช</option>
                  <option value="monthly">ุดูุฑู</option>
                  <option value="quarterly">ุฑุจุน ุณููู</option>
                  <option value="yearly">ุณููู</option>
                  <option value="trial">ุชุฌุฑูุจู</option>
                </select>
              </div>

              <div class="table-wrapper">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>ุงูุดุฑูุฉ</th>
                      <th>ุงูุจุงูุฉ</th>
                      <th>ุงููุจูุบ</th>
                      <th>ุชุงุฑูุฎ ุงูุจุฏุก</th>
                      <th>ุชุงุฑูุฎ ุงูุงูุชูุงุก</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (sub of filteredRecentSubscriptions; track sub.id) {
                      <tr>
                        <td>#{{ sub.id }}</td>
                        <td>
                          <div class="company-info">
                            <strong>{{ sub.company.name }}</strong>
                            <small>{{ sub.company.email }}</small>
                          </div>
                        </td>
                        <td>
                          <span class="badge" 
                                [ngClass]="sub.plan.name === 'Trial' ? 'badge-warning' : 'badge-success'">
                            {{ sub.plan.nameAr || (sub.plan.name === 'Trial' ? 'ุชุฌุฑุจุฉ ูุฌุงููุฉ' : sub.plan.nameAr) }}
                          </span>
                        </td>
                        <td class="amount">
                          {{ sub.plan.name === 'Trial' ? 'ูุฌุงูู' : formatCurrency(sub.plan.price) }}
                        </td>
                        <td class="date">{{ sub.startDate | date: 'dd/MM/yyyy' }}</td>
                        <td class="date">{{ sub.endDate | date: 'dd/MM/yyyy' }}</td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            </div>
          }
        </div>
      }
    </div>
  </div>
</div>